# =============================================================================
# GitHub Actions Workflow for API Security Scanner v5.0
# =============================================================================
# This workflow automatically:
#   1. Scans your codebase for API endpoints with AI enrichment
#   2. Generates comprehensive OpenAPI specification with test payloads
#   3. Uploads to Invicti DAST for security testing
#   4. Comments on PRs with API changes
#
# Required Secrets (Settings > Secrets and variables > Actions):
#   - INVICTI_URL: Your Invicti instance URL
#   - INVICTI_USER: API User ID
#   - INVICTI_TOKEN: API Token
#   - INVICTI_WEBSITE_ID: Target Website ID
#
# AI Provider Secrets (at least one required for AI enrichment):
#   - ANTHROPIC_API_KEY: Anthropic Claude API key (default provider)
#   - OPENAI_API_KEY: OpenAI GPT-4 API key (optional)
#   - GOOGLE_API_KEY: Google Gemini API key (optional)
#   - AWS_ACCESS_KEY_ID: AWS Bedrock access key (optional)
#   - AWS_SECRET_ACCESS_KEY: AWS Bedrock secret key (optional)
#
# Usage: Place this file at .github/workflows/security.yml
# =============================================================================

name: API Security Scanner

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      invicti_sync:
        description: 'Upload to Invicti DAST'
        required: false
        default: false
        type: boolean
      ai_enrich:
        description: 'Enable AI-powered enrichment'
        required: false
        default: true
        type: boolean
      llm_provider:
        description: 'AI Provider (anthropic, openai, gemini, bedrock)'
        required: false
        default: 'anthropic'
        type: choice
        options:
          - anthropic
          - openai
          - gemini
          - bedrock

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  SCANNER_IMAGE: bolatahmett/api-scanner:latest
  # Set to 'true' to enable AI enrichment
  AI_ENRICHMENT_ENABLED: ${{ vars.AI_ENRICHMENT_ENABLED }}
  # Default AI provider (anthropic, openai, gemini, bedrock)
  DEFAULT_LLM_PROVIDER: ${{ vars.DEFAULT_LLM_PROVIDER }}

jobs:
  # ===========================================================================
  # Job 1: API Discovery Scan
  # ===========================================================================
  api-scan:
    name: API Discovery Scan
    runs-on: ubuntu-latest
    outputs:
      endpoint_count: ${{ steps.scan.outputs.endpoint_count }}
      critical_count: ${{ steps.scan.outputs.critical_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull scanner image
        run: docker pull ${{ env.SCANNER_IMAGE }}

      - name: Create output directory
        run: |
          mkdir -p ${{ github.workspace }}/output
          chmod 777 ${{ github.workspace }}/output

      - name: Run API Scanner with AI Enrichment
        id: scan
        run: |
          # Determine if AI enrichment should be enabled
          AI_ENRICH="${{ env.AI_ENRICHMENT_ENABLED }}"
          if [ "${{ github.event.inputs.ai_enrich }}" != "" ]; then
            AI_ENRICH="${{ github.event.inputs.ai_enrich }}"
          fi
          # Convert to lowercase for case-insensitive comparison
          AI_ENRICH=$(echo "$AI_ENRICH" | tr '[:upper:]' '[:lower:]')

          # Determine LLM provider
          LLM_PROVIDER="${{ env.DEFAULT_LLM_PROVIDER }}"
          if [ "${{ github.event.inputs.llm_provider }}" != "" ]; then
            LLM_PROVIDER="${{ github.event.inputs.llm_provider }}"
          fi
          # Convert to lowercase
          LLM_PROVIDER=$(echo "$LLM_PROVIDER" | tr '[:upper:]' '[:lower:]')

          # Build docker command
          DOCKER_CMD="docker run --rm \
            -v ${{ github.workspace }}:/code:ro \
            -v ${{ github.workspace }}/output:/output \
            --user $(id -u):$(id -g)"

          # Add AI enrichment environment variables if enabled
          if [ "$AI_ENRICH" = "true" ]; then
            # Check if provider-specific API key is available
            HAS_API_KEY=false

            case "$LLM_PROVIDER" in
              anthropic)
                if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
                  echo "ü§ñ AI Enrichment: ENABLED (Anthropic Claude)"
                  DOCKER_CMD="$DOCKER_CMD \
                    -e SCANNER_AI_ENRICH=true \
                    -e LLM_PROVIDER=anthropic \
                    -e ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }} \
                    -e ENRICHMENT_MAX_WORKERS=3"
                  HAS_API_KEY=true
                fi
                ;;
              openai)
                if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
                  echo "ü§ñ AI Enrichment: ENABLED (OpenAI GPT-4)"
                  DOCKER_CMD="$DOCKER_CMD \
                    -e SCANNER_AI_ENRICH=true \
                    -e LLM_PROVIDER=openai \
                    -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
                    -e ENRICHMENT_MAX_WORKERS=3"
                  HAS_API_KEY=true
                fi
                ;;
              gemini)
                if [ -n "${{ secrets.GOOGLE_API_KEY }}" ]; then
                  echo "ü§ñ AI Enrichment: ENABLED (Google Gemini)"
                  DOCKER_CMD="$DOCKER_CMD \
                    -e SCANNER_AI_ENRICH=true \
                    -e LLM_PROVIDER=gemini \
                    -e GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }} \
                    -e ENRICHMENT_MAX_WORKERS=3"
                  HAS_API_KEY=true
                fi
                ;;
              bedrock)
                if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
                  echo "ü§ñ AI Enrichment: ENABLED (AWS Bedrock)"
                  # Use AWS_REGION from secrets if available, otherwise default to us-east-1
                  AWS_REGION_VALUE="${{ secrets.AWS_REGION }}"
                  if [ -z "$AWS_REGION_VALUE" ]; then
                    AWS_REGION_VALUE="us-east-1"
                  fi
                  echo "üìç AWS Region: $AWS_REGION_VALUE"
                  DOCKER_CMD="$DOCKER_CMD \
                    -e SCANNER_AI_ENRICH=true \
                    -e LLM_PROVIDER=bedrock \
                    -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
                    -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
                    -e AWS_REGION=$AWS_REGION_VALUE \
                    -e ENRICHMENT_MAX_WORKERS=3"
                  HAS_API_KEY=true
                fi
                ;;
            esac

            if [ "$HAS_API_KEY" = "false" ]; then
              echo "‚ö†Ô∏è AI Enrichment: DISABLED (no API key found for $LLM_PROVIDER)"
              echo "üìã Falling back to basic scan"
            fi
          else
            echo "üìã AI Enrichment: DISABLED (basic scan only)"
          fi

          DOCKER_CMD="$DOCKER_CMD ${{ env.SCANNER_IMAGE }}"

          # Execute scan
          eval $DOCKER_CMD
          
          # Extract metrics
          ENDPOINT_COUNT=$(python3 -c "import json; f=open('output/openapi.json'); d=json.load(f); print(len(d.get('paths', {})))")
          echo "endpoint_count=$ENDPOINT_COUNT" >> $GITHUB_OUTPUT
          
          # Count critical/high risks
          CRITICAL_COUNT=$(python3 -c "
          import json
          with open('output/openapi.json') as f:
              spec = json.load(f)
          count = 0
          for path, methods in spec.get('paths', {}).items():
              for method, details in methods.items():
                  if isinstance(details, dict) and details.get('x-risk-level') in ['CRITICAL', 'HIGH']:
                      count += 1
          print(count)
          ")
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT

      - name: Upload OpenAPI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: output/openapi.json
          retention-days: 30

      - name: Upload Full Report
        uses: actions/upload-artifact@v4
        with:
          name: scan-report
          path: output/
          retention-days: 30

  # ===========================================================================
  # Job 2: API Diff on Pull Requests
  # ===========================================================================
  api-diff:
    name: API Change Detection
    runs-on: ubuntu-latest
    needs: api-scan
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull scanner image
        run: docker pull ${{ env.SCANNER_IMAGE }}

      - name: Download current spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: output/

      - name: Download previous spec from base branch
        id: previous
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: security.yml
          branch: ${{ github.base_ref }}
          name: openapi-spec
          path: output/previous/
          
      - name: Check if previous spec exists
        id: check_previous
        run: |
          if [ -f "output/previous/openapi.json" ]; then
            mv output/previous/openapi.json output/previous.json
            echo "has_previous=true" >> $GITHUB_OUTPUT
          else
            echo "has_previous=false" >> $GITHUB_OUTPUT
            echo "No previous OpenAPI spec found for comparison"
          fi

      - name: Compute API Diff
        id: diff
        if: steps.check_previous.outputs.has_previous == 'true'
        run: |
          # Simple Python-based diff comparison
          python3 << 'EOFPYTHON' > diff_output.txt
          import json
          import sys
          
          def load_spec(file):
              try:
                  with open(file) as f:
                      return json.load(f)
              except:
                  return {'paths': {}}
          
          current = load_spec('output/openapi.json')
          previous = load_spec('output/previous.json')
          
          current_paths = set(current.get('paths', {}).keys())
          previous_paths = set(previous.get('paths', {}).keys())
          
          added = current_paths - previous_paths
          removed = previous_paths - current_paths
          
          print("=" * 60)
          print("API DIFF SUMMARY")
          print("=" * 60)
          print(f"\nüìä Total Current Endpoints: {len(current_paths)}")
          print(f"üìä Total Previous Endpoints: {len(previous_paths)}")
          
          if added:
              print(f"\n‚úÖ Added Endpoints ({len(added)}):")
              for path in sorted(added):
                  methods = list(current['paths'][path].keys())
                  print(f"  + {path} [{', '.join(m.upper() for m in methods)}]")
          
          if removed:
              print(f"\n‚ùå Removed Endpoints ({len(removed)}):")
              for path in sorted(removed):
                  methods = list(previous['paths'][path].keys())
                  print(f"  - {path} [{', '.join(m.upper() for m in methods)}]")
          
          if not added and not removed:
              print("\n‚ú® No API changes detected")
          
          print("\n" + "=" * 60)
          EOFPYTHON
          
          # Extract diff summary for PR comment
          echo "diff_summary<<EOF" >> $GITHUB_OUTPUT
          cat diff_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: steps.check_previous.outputs.has_previous == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const diffSummary = `${{ steps.diff.outputs.diff_summary }}`;
            const endpointCount = '${{ needs.api-scan.outputs.endpoint_count }}';
            const criticalCount = '${{ needs.api-scan.outputs.critical_count }}';
            
            const aiEnriched = '${{ env.AI_ENRICHMENT_ENABLED }}' === 'true' ? 'ü§ñ AI-Enriched' : 'üìã Basic';

            const body = `## üîç API Security Scan Results

            | Metric | Value |
            |--------|-------|
            | Total Endpoints | ${endpointCount} |
            | Critical/High Risk | ${criticalCount} |
            | Scan Mode | ${aiEnriched} |

            <details>
            <summary>üìä API Diff Details</summary>

            \`\`\`
            ${diffSummary}
            \`\`\`

            </details>

            ${aiEnriched === 'ü§ñ AI-Enriched' ? '‚ú® **AI Enrichment Enabled**: Complete schemas, auth configs, and security test payloads included' : ''}

            ---
            *Generated by Universal Polyglot API Scanner v5.0*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ===========================================================================
  # Job 3: Invicti DAST Upload
  # ===========================================================================
  invicti-upload:
    name: Upload to Invicti DAST
    runs-on: ubuntu-latest
    needs: api-scan
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') ||
      github.event.inputs.invicti_sync == 'true'
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull scanner image
        run: docker pull ${{ env.SCANNER_IMAGE }}

      - name: Download OpenAPI spec
        uses: actions/download-artifact@v4
        with:
          name: openapi-spec
          path: output/

      - name: Upload AI-Enriched Spec to Invicti
        run: |
          echo "üì§ Uploading AI-enriched OpenAPI spec to Invicti DAST..."
          docker run --rm \
            -v ${{ github.workspace }}/output:/output \
            -e INVICTI_URL=${{ secrets.INVICTI_URL }} \
            -e INVICTI_USER=${{ secrets.INVICTI_USER }} \
            -e INVICTI_TOKEN=${{ secrets.INVICTI_TOKEN }} \
            -e INVICTI_WEBSITE_ID=${{ secrets.INVICTI_WEBSITE_ID }} \
            --entrypoint python \
            ${{ env.SCANNER_IMAGE }} \
            /app/invicti_sync.py --file /output/openapi.json

      - name: Summary
        run: |
          echo "## üõ°Ô∏è Invicti DAST Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Endpoints: ${{ needs.api-scan.outputs.endpoint_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The discovered APIs have been uploaded to Invicti for DAST scanning." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 4: Security Gate (Block on Critical)
  # ===========================================================================
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: api-scan
    if: github.event_name == 'pull_request'
    steps:
      - name: Check for Critical Issues
        run: |
          CRITICAL=${{ needs.api-scan.outputs.critical_count }}
          echo "Critical/High risk endpoints: $CRITICAL"
          
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::warning::Found $CRITICAL critical/high risk API endpoints"
            # Uncomment to block PRs with critical issues:
            # exit 1
          else
            echo "‚úÖ No critical security issues found"
          fi
